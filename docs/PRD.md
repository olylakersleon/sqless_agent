# 数据分析 Agent：指标映射与口径澄清系统 PRD

## 1. 背景与问题陈述
- 目标：构建从自然语言分析需求到可信 SQL 执行的闭环，解决“业务语义→数据物理层”映射难题。
- 痛点：指标/口径多版本并存且变化快，部落知识分散；一次错数即失信；2B 场景叠加权限、审计要求。

## 2. 目标与范围
### 2.1 MVP 必达
1. 低摩擦澄清：在口径不确定时，通过最少 3 个槽位问题收敛到可执行 Metric Spec。
2. 资产化：每次澄清沉淀为可复用的结构化指标资产（热知识），并可与冷知识库并存。
3. 可解释与审计：输出携带口径摘要、数据来源、版本/确认人、关键过滤与时间口径。
4. 人机协同控制打扰：优先候选检索与最小澄清，必要时路由专家签名。

### 2.2 非目标（本期不做）
- 一次性建设全量权威指标库。
- 追求 100% 自动映射；允许 HITL。
- 完整 BI 可视化功能。

## 3. 用户与场景
- 业务用户：提问，期望快速可信结果；不懂表字段。
- 分析师：懂指标与维度；能轻量修正。
- 指标 Owner/专家：对口径有解释权；时间宝贵。
- 平台/治理管理员：负责权限、审计、生命周期。

核心 P0 场景：行业 GMV 趋势、类目/业务线 GMV & 订单量 & 转化率、渠道归因 GMV。

## 4. 核心概念：Metric Spec
最小可复用、可治理对象，包含：
- 语义：名称/别名/域、描述、默认粒度与维度、时间口径。
- 计算/口径：事实口径、过滤、去重、归因方式。
- 数据映射：事实/汇总表、字段、Join 关系、维表映射、分区提示。
- 治理：版本号、生效区间、变更记录、owner/确认人、状态（verified/draft）。
- 安全：权限角色、行列级策略、脱敏规则。
- 质量：对账/校验规则与频率。

## 5. 端到端方案概述
1. **意图解析**：抽取指标、维度、时间范围、粒度、过滤等槽位。
2. **候选检索**：在指标资产库（热/冷）与真实资产信号（SQL 日志、报表、元数据）中检索 Top-K Metric Spec，返回摘要卡片。
3. **不确定性检测**：置信度、冲突、关键槽位缺失、权限风险、跨域 Join 模式缺模板→触发澄清或专家流。
4. **澄清交互**：Top-K 选择 + 最小 3 问（GMV 口径/行业定义/时间口径等），冲突修正页，确认页，槽位表单（高级）。
5. **专家协同**：生成 Spec 草稿 v0.1（高亮缺口 + 推荐候选），路由 1~3 个专家，一键确认/轻量修正/转发，产出新版本并回填。
6. **SQL 生成与执行**：基于 Metric Spec 模板/规则生成；执行前做权限/代价/安全检查；执行后输出结果与溯源。
7. **Show Your Work**：展示使用的 Spec（名称/版本/生效区间）、口径摘要、数据源、确认人、关键 where/join 摘要、校验线索。

## 6. 关键模块需求
### 6.1 候选检索
- 输入：用户 query + 初始槽位。
- 信号源：语义层/指标平台、报表资产、SQL 历史日志、元数据中心、组织信息。
- 输出卡片要素：口径摘要、默认粒度、关键过滤、数据源、owner/更新时间、置信度（可选）。

### 6.2 不确定性门控
- 触发：Top1 置信度<0.85 或与 Top2 差距<0.15；存在冲突；关键槽位缺失；权限风险；跨域 join 无模板。
- 策略：0.65~0.85 → 最小澄清；<0.65 或高风险 → 专家签名流。

### 6.3 澄清交互
- 普通用户一次最多问 3 个问题；主交互：
  - 候选卡选择页。
  - 最小三问：GMV 口径（下单/支付/结算）、行业定义（类目/商家/内容）、时间口径（自然日/业务日）。
  - 冲突修正页（A/B 解释）。
  - 确认页（口径摘要 + 执行按钮）。
  - 槽位表单（高级单选/枚举/搜索下拉）。
- 开放文本需被结构化为槽位。

### 6.4 专家签名流
- 卡片内容：原始问题、系统推断摘要、不确定槽位高亮（≤5）、推荐候选 A/B/C。
- 操作：一键确认、轻量修正后确认（下拉选表/字段，NL→SQL 片段即时预览）、转发他人。
- 可选“仅本次 / 沉淀通用版本”（默认沉淀）。

### 6.5 指标资产库（Hot/Cold）
- 冷层：官方稳定指标；热层：运行时澄清/专家确认生成的资产，按热度+新鲜度排序。
- 能力：向量+结构化检索、版本控制、冲突管理、权限绑定、生命周期（deprecated）。

### 6.6 SQL 生成前后检查
- 基于 Spec 模板/规则生成，禁止纯模型臆造直跑生产。
- 前置：权限校验、代价评估、敏感字段脱敏/限行。
- 后置：执行失败回写 Spec 状态“需更新”，提示字段/表变更并通知 owner。

### 6.7 审计与信任
- 结果页折叠展示：Spec 名称/版本/生效区间、口径摘要、数据源/owner、关键 where/join 摘要、校验信息（对账/抽样时间）。
- 全链路审计日志：意图、选项、路由、确认、SQL、结果访问。

## 7. 数据结构建议
### 7.1 Metric Spec（JSON/表）
- `meta`：名称/别名/域/描述/状态/owner/verified_by/创建更新/热度/标签。
- `semantics`：类型、默认指标字段、粒度（时间+维度）、时间语义（事件时间、时区、业务日）、过滤、行业映射、归因。
- `physical`：事实表、时间列、度量列、维表 join、分区提示、SQL 模板。
- `governance`：版本、生效区间、变更日志、冲突策略。
- `security`：行列级策略、脱敏、角色允许列表。
- `quality`：校验/对账规则。

### 7.2 运行时会话状态
- 会话 ID、用户、解析的槽位（指标/维度/时间/粒度/过滤）、置信度、候选列表、澄清历史、专家路由状态、最终 Spec 版本。

## 8. 关键流程
1. **自助澄清流**：
   - 输入 → 意图解析 → 候选检索 → 置信度判定 →（最小三问）→ 确认页 → SQL 生成/执行 → 结果+溯源 → 是否沉淀偏好。
2. **专家签名流（异步）**：
   - 低置信/高风险 → 生成 v0.1 草稿 → 路由专家 → 确认/修正 → 产出 v1 verified → 执行并通知 → 写入热层。

## 9. 策略与运营
- 打扰控制：每日专家配额，相似请求合并；超时 fallback 提示用户自行选择候选。
- 冲突处理：同名指标多版本并存需标注适用范围；默认策略=同域优先+verified 优先+最新优先+热度加权；无法裁决时让用户/专家选择版本。
- 可观测指标：澄清率、专家介入率、复用率、错数率、满意度、候选命中率。

## 10. MVP 里程碑与交付
- **M0（1 周）**：完成 Metric Spec schema、热/冷资产存取 API、意图解析占位、候选检索 stub、最小三问与确认页原型（低保真）。
- **M1（3 周）**：上线自助澄清主流程（含置信度门控）、SQL 生成模板化、Show Your Work 报告、审计日志 MVP、热知识沉淀。
- **M2（6 周）**：专家签名流、权限/代价检查、对账规则、冲突管理、运营看板。

## 11. 风险与应对
- 错数风险 → 强制确认页 + 溯源 + 抽样对账。
- 专家不响应 → 路由策略 + 值班机制 + 超时 fallback。
- 口径冲突 → 版本化 + 适用范围标注 + 显式选择。
- 用户拒绝澄清 → 默认候选 + 最少问题 + “找人确认”备用。
- 资产老化 → 执行失败自动回写需更新并通知 owner；热度/新鲜度驱动维护。
